using System;
using System.Text;
using System.Collections.Generic;
using System.Linq;
using Microsoft.Concurrency.TestTools.UnitTesting;
using System.Diagnostics;
using System.Threading;

namespace MiniMPI.Testing
{
	/// <summary>
	/// Tests basic Send-Recv-Wait functionality of the runtime.
	/// </summary>
	
	public class StoreBufferVulnerabilityTest : MpiTestBase
	{

		/// <summary>
		/// When this test is run, a store buffer vulnerability error occurred.
		/// To see this fail, add the following condition to the MiniMPI project:
		/// SHOW_STORE_BUFFER_VULNERABILITY_BUG
		/// </summary>
		[ScheduleTestMethod]
		public void Attempt1()
		{
			ExecuteMpiProgram(1, mpi =>
			{
				mpi.MpiInit();

				// P0
				var h00 = mpi.SendAsync(0, "s00", true);
				mpi.Wait(h00);   // no-op

				mpi.MpiFinalize();
			});
		}
	}
}
